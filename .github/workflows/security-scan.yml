name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript, typescript
        queries: security-and-quality

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"
      continue-on-error: true

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate --json > audit-results.json || true
        npm audit --audit-level=moderate

    - name: Check for high/critical vulnerabilities
      run: |
        if npm audit --audit-level=high; then
          echo "High or critical vulnerabilities found!"
          exit 1
        else
          echo "No high or critical vulnerabilities found."
        fi

    - name: Upload audit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: npm-audit-results
        path: audit-results.json

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if there are changes to scan
      id: check-changes
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "push" ]; then
          # For push events, check if there are commits to compare
          if [ "${{ github.event.before }}" != "${{ github.sha }}" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
        else
          # For scheduled runs, scan the entire repository
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: TruffleHog OSS (with changes)
      if: steps.check-changes.outputs.changes == 'true' && github.event_name == 'pull_request'
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha }}
        head: ${{ github.event.pull_request.head.sha }}
        extra_args: --debug --only-verified

    - name: TruffleHog OSS (full scan)
      if: steps.check-changes.outputs.changes == 'true' && github.event_name != 'pull_request'
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        extra_args: --debug --only-verified

    - name: TruffleHog OSS (skip scan)
      if: steps.check-changes.outputs.changes == 'false'
      run: |
        echo "⚠️ No changes detected to scan with TruffleHog"
        echo "This can happen when BASE and HEAD commits are the same"

    - name: GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install license-checker
      run: npm install -g license-checker

    - name: Check licenses (strict mode)
      id: license-strict
      run: |
        echo "Checking licenses in strict mode..."
        npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;Unlicense;CC0-1.0;Python-2.0;LGPL-2.1;LGPL-3.0;MPL-2.0' --excludePrivatePackages --json > license-report.json || echo "strict-check-failed"
      continue-on-error: true

    - name: Check licenses (permissive mode)
      id: license-permissive
      run: |
        echo "Checking licenses in permissive mode..."
        npx license-checker --excludePrivatePackages --json > license-report-permissive.json
      continue-on-error: true

    - name: Generate license report
      run: |
        echo "## License Compliance Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "license-report.json" ]; then
          echo "### ✅ All licenses are compliant" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies use approved licenses." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ⚠️ Some licenses need review" >> $GITHUB_STEP_SUMMARY
          echo "The following dependencies use non-standard licenses:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "license-report-permissive.json" ]; then
            echo "| Package | License |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
            
            # Extract non-compliant licenses
            npx license-checker --excludePrivatePackages --json | jq -r 'to_entries[] | select(.value.licenses | test("MIT|Apache-2.0|BSD-2-Clause|BSD-3-Clause|ISC|Unlicense|CC0-1.0|Python-2.0|LGPL-2.1|LGPL-3.0|MPL-2.0") | not) | "| \(.key) | \(.value.licenses) |"' >> $GITHUB_STEP_SUMMARY || echo "| Unable to parse license data | |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This is a warning, not an error. Review these licenses and update the allowlist if needed." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload license reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-reports
        path: |
          license-report.json
          license-report-permissive.json

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-scan, secret-scan, license-scan]
    if: always()
    
    steps:
    - name: Security Scan Summary
      run: |
        echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CodeQL Analysis | ${{ needs.security-scan.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.secret-scan.result }}" = "success" ]; then
          echo "| Secret Detection | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.secret-scan.result }}" = "skipped" ]; then
          echo "| Secret Detection | ⏭️ Skipped (No changes) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Secret Detection | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.license-scan.result }}" = "success" ]; then
          echo "| License Check | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.license-scan.result }}" = "skipped" ]; then
          echo "| License Check | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| License Check | ⚠️ Warning (See details) |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Notes:" >> $GITHUB_STEP_SUMMARY
        echo "- Secret Detection may be skipped when there are no changes to scan" >> $GITHUB_STEP_SUMMARY
        echo "- This is normal behavior and not an error" >> $GITHUB_STEP_SUMMARY
